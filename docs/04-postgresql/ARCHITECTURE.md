# PostgreSQL Service Plus - æ­£ç¡®çš„æ¶æ„ç†è§£

## æ ¸å¿ƒè®¾è®¡

### ä¸¤ä¸ªç‹¬ç«‹çš„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å±‚æ¬¡ 1: HTTPS è¯ä¹¦ç®¡ç†å±‚ (Nginx/Caddy)                              â”‚
â”‚  ç›®çš„: ä¸ºåŸŸåç”³è¯·å’Œç®¡ç† Let's Encrypt è¯ä¹¦                            â”‚
â”‚  ç”¨é€”: Web ç•Œé¢ (pgAdmin, å¥åº·æ£€æŸ¥ç­‰)                                â”‚
â”‚  ä¸æ¶‰åŠ: SQL æµé‡ä»£ç†                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å±‚æ¬¡ 2: æ•°æ®åº“è®¿é—®å±‚ (Stunnel)                                      â”‚
â”‚  ç›®çš„: æä¾› HTTPS ç«¯ç‚¹ç”¨äºæ•°æ®åº“è¿æ¥                                  â”‚
â”‚  ä¼˜åŠ¿: é«˜æ€§èƒ½,ä¸ä½¿ç”¨ PostgreSQL sslmode                              â”‚
â”‚  ç«¯å£: 5433 (TLS/HTTPS)                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ­£ç¡®çš„æ¶æ„å›¾

```
äº’è”ç½‘
  â”‚
  â”œâ”€â”€â”€ HTTPS (443) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    ç”¨äº: Web ç•Œé¢è®¿é—®                                    â”‚
  â”‚    è¯ä¹¦: Nginx/Caddy ç®¡ç†çš„ Let's Encrypt              â”‚
  â”‚                                                        â”‚
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
  â”‚    â”‚ Nginx/Caddy  â”‚  ä»…ç”¨äºè¯ä¹¦ç®¡ç†å’Œ Web æœåŠ¡          â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
  â”‚           â”‚                                            â”‚
  â”‚           â†“                                            â”‚
  â”‚      /health, /pgadmin/, /metrics                     â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”œâ”€â”€â”€ TLS (5433) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚    ç”¨äº: æ•°æ®åº“è¿æ¥                                      â”‚
  â”‚    åè®®: PostgreSQL over TLS (stunnel)                 â”‚
  â”‚    æ€§èƒ½: é«˜æ€§èƒ½,ä¸ä½¿ç”¨ PostgreSQL sslmode               â”‚
  â”‚                                                        â”‚
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
  â”‚    â”‚   Stunnel    â”‚  HTTPS ç«¯ç‚¹ (5433)                 â”‚
  â”‚    â”‚   æœåŠ¡ç«¯      â”‚  â† æ‰€æœ‰æ•°æ®åº“è¿æ¥é€šè¿‡è¿™é‡Œ            â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
  â”‚           â”‚ è§£å¯† TLS                                   â”‚
  â”‚           â†“                                            â”‚
  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
  â”‚    â”‚  PostgreSQL  â”‚  127.0.0.1:5432                   â”‚
  â”‚    â”‚  (å†…éƒ¨éš”ç¦»)   â”‚  æ—  SSL å¼€é”€,æœ€é«˜æ€§èƒ½               â”‚
  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
  â”‚                                                        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡?

### 1. Nginx/Caddy åªç®¡è¯ä¹¦,ä¸ä»£ç† SQL

**ç›®çš„**:
- âœ… ä¸º `postgresql.svc.plus` ç”³è¯· HTTPS è¯ä¹¦
- âœ… æä¾› Web ç•Œé¢ (pgAdmin, å¥åº·æ£€æŸ¥)
- âœ… çµæ´»ç®¡ç†å¤šåŸŸåè¯ä¹¦
- âŒ **ä¸ä»£ç† SQL æµé‡** (é¿å…æ€§èƒ½æŸå¤±)

**é…ç½®ç¤ºä¾‹** (Nginx):
```nginx
# åªå¤„ç† HTTPS Web è¯·æ±‚,ä¸æ¶‰åŠ SQL
server {
    listen 443 ssl http2;
    server_name postgresql.svc.plus;
    
    # Let's Encrypt è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/postgresql.svc.plus/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/postgresql.svc.plus/privkey.pem;
    
    # Web ç•Œé¢
    location /pgadmin/ {
        proxy_pass http://pgadmin:80/;
    }
    
    location /health {
        return 200 "OK";
    }
    
    # ä¸ä»£ç† PostgreSQL è¿æ¥!
}
```

### 2. Stunnel æä¾›é«˜æ€§èƒ½ HTTPS ç«¯ç‚¹

**ç›®çš„**:
- âœ… æä¾› TLS åŠ å¯†çš„æ•°æ®åº“è¿æ¥ç«¯ç‚¹
- âœ… ä¸ä½¿ç”¨ PostgreSQL çš„ sslmode (é¿å…æ€§èƒ½å¼€é”€)
- âœ… PostgreSQL ä»¥æœ€é«˜æ€§èƒ½è¿è¡Œ (æ—  SSL å¼€é”€)
- âœ… TLS åŠ å¯†ç”± stunnel ä¸“é—¨å¤„ç†

**æ€§èƒ½ä¼˜åŠ¿**:

| æ–¹æ¡ˆ | PostgreSQL CPU | TLS å¤„ç† | æ€§èƒ½ |
|------|---------------|---------|------|
| **PostgreSQL sslmode** | å¤„ç† SQL + TLS | PostgreSQL | âš ï¸ è¾ƒæ…¢ |
| **Stunnel (æœ¬æ–¹æ¡ˆ)** | åªå¤„ç† SQL | Stunnel | âœ… æœ€å¿« |

**é…ç½®** (stunnel-server.conf):
```ini
[postgres-tls-server]
client = no
accept = 0.0.0.0:5433        # HTTPS ç«¯ç‚¹
connect = postgres:5432       # å†…éƒ¨æ— åŠ å¯†è¿æ¥

cert = /etc/stunnel/certs/server-cert.pem
key = /etc/stunnel/certs/server-key.pem

# é«˜æ€§èƒ½ TLS é…ç½®
sslVersion = TLSv1.2
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1
```

## å®é™…éƒ¨ç½²åœºæ™¯

### åœºæ™¯ A: åªéœ€è¦æ•°æ®åº“ (æ—  Web ç•Œé¢)

**éƒ¨ç½²**:
```bash
# åªå¯åŠ¨ PostgreSQL + Stunnel
docker-compose -f docker-compose.yml -f docker-compose.tunnel.yml up -d
```

**å¼€æ”¾ç«¯å£**:
- `5433` - Stunnel TLS ç«¯ç‚¹ (æ•°æ®åº“è¿æ¥)

**ä¸éœ€è¦**:
- âŒ Nginx/Caddy (å› ä¸ºæ²¡æœ‰ Web ç•Œé¢éœ€æ±‚)
- âŒ 443 ç«¯å£

### åœºæ™¯ B: æ•°æ®åº“ + Web ç®¡ç†ç•Œé¢

**éƒ¨ç½²**:
```bash
# åˆå§‹åŒ– HTTPS è¯ä¹¦ (ç”¨äº Web ç•Œé¢)
DOMAIN=postgresql.svc.plus EMAIL=admin@example.com ./init-letsencrypt.sh

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose \
  -f docker-compose.yml \
  -f docker-compose.nginx.yml \
  -f docker-compose.tunnel.yml \
  --profile admin \
  up -d
```

**å¼€æ”¾ç«¯å£**:
- `443` - Nginx HTTPS (Web ç•Œé¢: pgAdmin, å¥åº·æ£€æŸ¥)
- `5433` - Stunnel TLS (æ•°æ®åº“è¿æ¥)

**æµé‡åˆ†ç¦»**:
- Web æµé‡ â†’ 443 â†’ Nginx â†’ pgAdmin/health
- SQL æµé‡ â†’ 5433 â†’ Stunnel â†’ PostgreSQL

### åœºæ™¯ C: ä½¿ç”¨ Caddy (é›¶é…ç½®è¯ä¹¦)

**éƒ¨ç½²**:
```bash
docker-compose \
  -f docker-compose.yml \
  -f docker-compose.caddy.yml \
  -f docker-compose.tunnel.yml \
  up -d
```

**Caddyfile**:
```caddyfile
postgresql.svc.plus {
    # è‡ªåŠ¨ HTTPS è¯ä¹¦ (ç”¨äº Web)
    
    handle /health {
        respond "OK" 200
    }
    
    # ä¸ä»£ç† SQL!
}
```

## æ€§èƒ½å¯¹æ¯”

### æ–¹æ¡ˆ 1: PostgreSQL åŸç”Ÿ SSL (ä¸æ¨è)

```
å®¢æˆ·ç«¯ â†’ PostgreSQL:5432 (sslmode=require)
         â†“
    PostgreSQL å¤„ç†:
    - SQL æŸ¥è¯¢
    - TLS åŠ å¯†/è§£å¯†  â† é¢å¤– CPU å¼€é”€
```

**ç¼ºç‚¹**:
- âŒ PostgreSQL CPU è´Ÿæ‹…é‡
- âŒ æ€§èƒ½ä¸‹é™ 10-30%
- âŒ éš¾ä»¥ä¼˜åŒ–

### æ–¹æ¡ˆ 2: Stunnel (æœ¬é¡¹ç›®,æ¨è)

```
å®¢æˆ·ç«¯ â†’ Stunnel:5433 (TLS)
         â†“ è§£å¯†
    PostgreSQL:5432 (æ—  SSL)
         â†“
    PostgreSQL åªå¤„ç†:
    - SQL æŸ¥è¯¢  â† æœ€é«˜æ€§èƒ½
```

**ä¼˜ç‚¹**:
- âœ… PostgreSQL ä¸“æ³¨äº SQL,æœ€é«˜æ€§èƒ½
- âœ… Stunnel ä¸“é—¨ä¼˜åŒ– TLS å¤„ç†
- âœ… å¯ä»¥ç‹¬ç«‹æ‰©å±• (å¤šä¸ª stunnel å®ä¾‹)
- âœ… é›¶ SSL å¼€é”€

## å®¢æˆ·ç«¯è¿æ¥

### åº”ç”¨æœåŠ¡å™¨é…ç½®

**stunnel å®¢æˆ·ç«¯** (stunnel-client.conf):
```ini
[postgres-client]
client = yes
accept = 127.0.0.1:15432      # æœ¬åœ°ç«¯å£
connect = postgresql.svc.plus:5433  # Stunnel æœåŠ¡ç«¯
```

**åº”ç”¨è¿æ¥**:
```python
# Python
conn = psycopg2.connect(
    host="localhost",
    port=15432,
    user="postgres",
    password="password",
    database="dbname"
    # æ— éœ€ sslmode!
)
```

**æ€§èƒ½**:
- âœ… åº”ç”¨ â†’ stunnel å®¢æˆ·ç«¯: æœ¬åœ°è¿æ¥,æ— å»¶è¿Ÿ
- âœ… stunnel å®¢æˆ·ç«¯ â†’ stunnel æœåŠ¡ç«¯: TLS åŠ å¯†
- âœ… stunnel æœåŠ¡ç«¯ â†’ PostgreSQL: æœ¬åœ°è¿æ¥,æ—  SSL å¼€é”€
- âœ… **æ€»ä½“æ€§èƒ½æ¥è¿‘æ— åŠ å¯†è¿æ¥**

## æ€»ç»“

### Nginx/Caddy çš„ä½œç”¨

**ä»…ç”¨äº**:
1. ä¸ºåŸŸåç”³è¯· Let's Encrypt è¯ä¹¦
2. æä¾› Web ç•Œé¢ (pgAdmin, å¥åº·æ£€æŸ¥)
3. çµæ´»ç®¡ç†å¤šåŸŸå

**ä¸ç”¨äº**:
- âŒ ä»£ç† SQL æµé‡
- âŒ æ•°æ®åº“è¿æ¥

### Stunnel çš„ä½œç”¨

**ä¸“é—¨ç”¨äº**:
1. æä¾› HTTPS ç«¯ç‚¹ (5433)
2. é«˜æ€§èƒ½ TLS åŠ å¯†æ•°æ®åº“è¿æ¥
3. æ›¿ä»£ PostgreSQL sslmode

**æ€§èƒ½ä¼˜åŠ¿**:
- âœ… PostgreSQL æ—  SSL å¼€é”€
- âœ… ä¸“é—¨çš„ TLS å¤„ç†
- âœ… å¯ç‹¬ç«‹æ‰©å±•

### æ ¸å¿ƒä»·å€¼

**"çµæ´»çš„è¯ä¹¦ç®¡ç† + é«˜æ€§èƒ½çš„åŠ å¯†è¿æ¥"**

- Nginx/Caddy: è¯ä¹¦ç®¡ç†çš„çµæ´»æ€§
- Stunnel: æ•°æ®åº“è¿æ¥çš„é«˜æ€§èƒ½

ä¸¤è€…å„å¸å…¶èŒ,äº’ä¸å¹²æ‰°! ğŸ¯
